"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),_fibonacciDelay=require("./strategies/delay/fibonacci-delay"),_fibonacciDelay2=_interopRequireDefault(_fibonacciDelay),_exponentialDelay=require("./strategies/delay/exponential-delay"),_exponentialDelay2=_interopRequireDefault(_exponentialDelay),_catchAll=require("./strategies/errorhandler/catch-all"),_catchAll2=_interopRequireDefault(_catchAll),_defaultLogger=require("./strategies/log/default-logger"),_defaultLogger2=_interopRequireDefault(_defaultLogger);function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _asyncToGenerator(a){return function(){var b=a.apply(this,arguments);return new Promise(function(a,c){function d(e,f){try{var g=b[e](f),h=g.value}catch(a){return void c(a)}return g.done?void a(h):Promise.resolve(h).then(function(a){d("next",a)},function(a){d("throw",a)})}return d("next")})}}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var CONFIG={maxTries:10},RetryOnError=function(){function a(b,c,d,e,f){_classCallCheck(this,a),this._delayStrategy=c,this._errorHandlerStrategy=d,this._logStrategy=e,this._context=f,this.asyncFunction=b,this.run=this.run.bind(this)}return _createClass(a,null,[{key:"create",value:function(b,c){return a.createWithStrategy(b,{delayStrategy:new _fibonacciDelay2.default(c||CONFIG.maxTries),errorHandlerStrategy:new _catchAll2.default,logStrategy:_defaultLogger2.default.logError})}},{key:"createWithStrategy",value:function(b,c){var d=c.delayStrategy,e=c.errorHandlerStrategy,f=c.logStrategy,g=c.context;return new a(b,d||new _fibonacciDelay2.default(CONFIG.maxTries),e||new _catchAll2.default,f||_defaultLogger2.default.logError,g||{})}},{key:"runExponential",value:function(){var b=_asyncToGenerator(regeneratorRuntime.mark(function b(c){var d,e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},f=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},g=f.maxTries,h=void 0===g?5:g,i=f.exponentialBase,j=void 0===i?2:i,k=f.multiplier,l=void 0===k?5:k,m=f.errorHandlerStrategy,n=void 0===m?new _catchAll2.default:m,o=f.logStrategy,p=void 0===o?_defaultLogger2.default.logError:o;return regeneratorRuntime.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return d=a.createWithStrategy(c,{delayStrategy:new _exponentialDelay2.default(h,l,j),errorHandlerStrategy:n,logStrategy:p,context:e}),b.next=3,d.run();case 3:return b.abrupt("return",b.sent);case 4:case"end":return b.stop();}},b,this)}));return function(){return b.apply(this,arguments)}}()},{key:"runFibonacci",value:function(){var b=_asyncToGenerator(regeneratorRuntime.mark(function b(c){var d,e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},f=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},g=f.maxTries,h=void 0===g?5:g,i=f.multiplier,j=void 0===i?5:i,k=f.errorHandlerStrategy,l=void 0===k?new _catchAll2.default:k,m=f.logStrategy,n=void 0===m?_defaultLogger2.default.logError:m;return regeneratorRuntime.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return d=a.createWithStrategy(c,{delayStrategy:new _fibonacciDelay2.default(h,j),errorHandlerStrategy:l,logStrategy:n,context:e}),b.next=3,d.run();case 3:return b.abrupt("return",b.sent);case 4:case"end":return b.stop();}},b,this)}));return function(){return b.apply(this,arguments)}}()},{key:"runConstant",value:function(){var b=_asyncToGenerator(regeneratorRuntime.mark(function b(c){var d,e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},f=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},g=f.maxTries,h=void 0===g?5:g,i=f.multiplier,j=void 0===i?5:i,k=f.errorHandlerStrategy,l=void 0===k?new _catchAll2.default:k,m=f.logStrategy,n=void 0===m?_defaultLogger2.default.logError:m;return regeneratorRuntime.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return d=a.createWithStrategy(c,{delayStrategy:new _exponentialDelay2.default(h,j,1),errorHandlerStrategy:l,logStrategy:n,context:e}),b.next=3,d.run();case 3:return b.abrupt("return",b.sent);case 4:case"end":return b.stop();}},b,this)}));return function(){return b.apply(this,arguments)}}()}]),_createClass(a,[{key:"run",value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(){var b,c,d;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:b=0,c=void 0,d=0;case 3:return c=!0,b++,a.prev=5,a.next=8,this.asyncFunction();case 8:return a.abrupt("return",a.sent);case 11:if(a.prev=11,a.t0=a["catch"](5),this._errorHandlerStrategy.canCatch(a.t0)){a.next=15;break}throw a.t0;case 15:if(this._logStrategy(a.t0,{attempts:b,lastDelayTime:d,context:this._context}),c=!1,!(b>this._delayStrategy.maxTries)){a.next=19;break}throw a.t0;case 19:return a.next=21,this._delayStrategy.delay(b);case 21:d=a.sent;case 22:if(!c){a.next=3;break}case 23:case"end":return a.stop();}},a,this,[[5,11]])}));return function(){return a.apply(this,arguments)}}()}]),a}();exports.default=RetryOnError;